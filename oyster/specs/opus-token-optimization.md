# Opus Token 消耗分析与优化方案

> 分析时间: 2026-02-11
> 数据来源: 33 sessions, 329MB 日志, 26,510 次工具调用

## Token 杀手排名

| # | 环节 | 占比 | 次数 | 说明 |
|---|------|------|------|------|
| 1 | Bash 命令 (SSH + 本地) | 31% | 8,350 | 平均 41次/session，很多可 && 合并 |
| 2 | Read 文件 | 29% | 7,739 | 反复读同一文件、读完整大文件不截断 |
| 3 | 浏览器自动化 | ~15% | 1,675+1,018截图 | 每张截图 ≈ 1000-2000 token |
| 4 | 超时/重试循环 | 10-15% | 3,310 timeout | 89% session 受影响 |
| 5 | Task subagent | 8% | 2,251 | 需确认是否都用 haiku |
| 6 | 计划 + 验收 | <5% | — | 最便宜的环节 |

## 核心结论

- **计划和验收不是问题** — 只占不到 5%
- **执行层浪费最大**: 浏览器截图 + SSH 命令碎片化 + 文件重复读取
- **截图是隐形杀手**: 1,018 张截图，每张 1000-2000 token = 100万-200万 token

## 优化方案 (预计节省 40-60%)

| 优先级 | 做法 | 预计节省 |
|--------|------|---------|
| P0 | **浏览器操作 dispatch 给 Codex**，Opus 不碰截图 | 15-20% |
| P0 | **Bash 命令合并** (用 && 链接) | 5-10% |
| P1 | **Read 文件用 limit 截断**，不读完整大文件 | 5-10% |
| P1 | **SSH 操作用 haiku subagent** | 5-10% |
| P2 | **超时加 circuit breaker**，不盲目重试 | 5-10% |

## 铁律强化

- Opus 绝不做浏览器截图/DOM 操作 → dispatch Codex
- Bash 3 个以上独立命令 → 用 && 合并为 1 次调用
- Read 大文件 → 必须加 limit 参数或 head/tail
- SSH 检查/安装类操作 → Task(model: "haiku")
- 超时 2 次 → 停止重试，换方案
