# Discord 管理自动化 Issue Log（Oyster Republic）

目标：在 `Oyster Republic` Discord 里清理误发的批量回复，并后续做到 **逐条、对原消息使用 Reply** 的慢速回复（避免“挤在一起”刷屏）。

## 1) 误发消息“挤在一起”问题（产品/执行层面）

### 现象
- 机器人/账号 `Oysterguard` 在 `#general-english` 一次性发出一长串 `@user: Sorry about this...` 模板回复。
- 用户侧观感为刷屏、像群发/营销，且无法对应到每个人原始问题（没有使用 Discord 的 **Reply** 关联上下文）。

### 期望
- 每条回复都应：
  - 使用 Discord 的 **Reply（回复）** 功能，绑定到某一条用户消息
  - 单条发送，且有节奏（例如每 8-15 秒一条），避免短时间多条

### 可能原因
- 自动化实现为“收集多个用户 -> 拼接成一个/连续多条普通消息”的发送逻辑
- 或未点击 message action 里的 Reply，而是直接在输入框发送

### 验收标准
- 在 `#general-english`：
  - 不再出现批量 `@user:` 拼接式内容
  - 新回复均为“引用回复”（UI 上能看到 Reply 关联）
  - 连续发送速率可控（可配置 delay）


## 2) 删除误发消息：右键菜单不稳定 + 多语言文案差异

### 现象
- Discord 网页/桌面 UI（中文界面）中，删除菜单项文案为 **“删除信息”**（不是“删除消息”）。
- 自动化在不同 DOM 位置右键会打开不同菜单：
  - 右键消息内容区域有时只出现“复制链接”等 link context menu（尤其当消息内有 channel mention/link，例如 `#announcements`）
  - 右键 message `li` 容器经常失效或命中错误元素
- 可靠性提升的 workaround：右键点击消息的 `time` 元素（时间戳）更稳定出现完整 message menu，然后选择“删除信息”。

### 复现步骤（稳定）
1. 打开：`https://discord.com/channels/1404726112159793172/1404870331759591575`（#general-english）
2. 定位到 `Oysterguard — 17:42` 附近的模板回复
3. 尝试对包含链接/频道 mention 的模板消息（如包含 `#announcements`）右键消息内容
4. 观察：弹出的菜单可能只有“复制链接”类选项，无法删除
5. 改为右键点击该消息的时间戳（`time`），此时能出现“删除信息”

### 受影响消息示例（messageId）
- `1469871129568215214`（含 `#announcements` 的模板内容，曾触发 link menu）
- 其他仍残留的模板消息（DOM 中曾见到）：
  - `1469871135066816543`, `1469871145170767885`, `1469871149985956082`, `1469871155803590689`, `1469871160450613544`
  - `1469871890129752284`, `1469871897981354261`, `1469871904151306443`, `1469871910887096496`, `1469871917682004009`, `1469871925093204138`, `1469871931728724265`

### 可能原因
- Discord 对链接/mention 区域触发不同 context menu（link context vs message context）
- 不同语言 UI 文案导致 selector 仅匹配英文/或错误中文

### 建议修复（工程）
- 菜单项匹配同时支持：
  - 中文：`删除信息`、确认按钮 `删除`
  - 英文：`Delete Message`、确认按钮 `Delete`
- 右键目标元素优先级：
  1) `time`（时间戳）
  2) message header / avatar
  3) message content（最后才用）
- 对“只出现复制链接菜单”的情况：自动切换到 `time` 右键策略

### 验收标准
- 在中文 UI + 英文 UI 下均可稳定删除指定消息
- 对含 `#channel` / link 的消息也能删除


## 3) 虚拟滚动 + 批量操作超时（工具链稳定性）

### 现象
- Discord 消息列表是虚拟化渲染：DOM 只保留当前可视区域附近的 `li[id^="chat-messages-"]`。
- 一次性删除太多条会导致自动化超时/中断（工具侧 60s deadline）或因列表重排导致定位错位。

### 建议修复
- 删除/回复采取小批量：每次 3-5 条，完成后重新抓取 DOM，再继续。
- 每次操作后等待 UI 稳定（菜单消失、消息从列表移除）再继续。

### 验收标准
- 可连续清理 20+ 条模板消息，过程中不出现定位到错误消息/误删、也不超时。


## 4) “逐条回复”实现要求（功能需求，避免再次刷屏）

### 需求
- 对每个用户的原始抱怨消息：
  - 跳转到该消息 permalink（`/channels/<guild>/<channel>/<messageId>`）
  - 使用 message action 的 Reply
  - 发送 1-3 句真诚回复（可根据用户语言选择 EN/ZH 等）
  - 每条之间 `delay`（默认 8-15 秒，可配置）

### 验收标准
- Reply 形式正确（UI 有引用）
- 不再出现“挤在一起”的连续群发观感


## 附：环境信息（可补充）
- Guild: `Oyster Republic`（ID `1404726112159793172`）
- Channel: `#general-english`（ID `1404870331759591575`）
- 另有中文频道：`#chinese`（ID `1416430673652355112`）
- UI 语言：中文（至少在部分客户端）

